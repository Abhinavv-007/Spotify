<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Abhinav's Spotify - Ultimate Edition</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* =========================================================
       10/10 FUTURISTIC UI SYSTEM (Spotify + Apple Music vibe)
       - Keeps your mesh, lyrics, fullscreen, dynamic bg, etc.
       - Upgrades tokens + surfaces + cards + nav + scroll polish
       ========================================================= */

        :root {
            --bg0: #05070a;
            --bg1: #070b12;

            --panel: rgba(255, 255, 255, .035);
            --panel2: rgba(255, 255, 255, .06);

            --stroke: rgba(255, 255, 255, .08);
            --stroke2: rgba(255, 255, 255, .14);

            --text: rgba(255, 255, 255, .92);
            --muted: rgba(255, 255, 255, .58);
            --muted2: rgba(255, 255, 255, .40);

            --accent: #ffffff;
            --accentGlow: rgba(255, 255, 255, .25);

            --shadow: 0 20px 60px rgba(0, 0, 0, .55);
            --shadow2: 0 30px 90px rgba(0, 0, 0, .65);

            --r-xl: 28px;
            --r-lg: 20px;
            --r-md: 16px;
            --r-sm: 12px;

            --text-glow: rgba(255, 255, 255, 0.6);
        }

        body {
            background:
                radial-gradient(1200px 800px at 20% -10%, rgba(79, 172, 254, .10), transparent 60%),
                radial-gradient(900px 600px at 90% 10%, rgba(255, 255, 255, .06), transparent 55%),
                var(--bg0);
            color: var(--text);
            transition: background-color 1s ease;
            text-rendering: geometricPrecision;
            -webkit-font-smoothing: antialiased;
        }

        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Optional: premium scrollbar for desktop areas (use with class pretty-scrollbar) */
        .pretty-scrollbar::-webkit-scrollbar {
            width: 10px;
        }

        .pretty-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, .10);
            border-radius: 999px;
            border: 2px solid rgba(0, 0, 0, 0);
            background-clip: padding-box;
        }

        .pretty-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, .16);
        }

        /* Smooth Static Mesh Animations for Outer Theme */
        @keyframes blob-spin {
            0% {
                transform: rotate(0deg) scale(1);
            }

            50% {
                transform: rotate(180deg) scale(1.06);
            }

            100% {
                transform: rotate(360deg) scale(1);
            }
        }

        @keyframes blob-spin-reverse {
            0% {
                transform: rotate(360deg) scale(1);
            }

            50% {
                transform: rotate(180deg) scale(1.10);
            }

            100% {
                transform: rotate(0deg) scale(1);
            }
        }

        .mesh-blob-1 {
            animation: blob-spin 40s infinite linear;
            transform-origin: center;
            background: radial-gradient(circle, rgba(79, 172, 254, 0.15) 0%, transparent 70%);
        }

        .mesh-blob-2 {
            animation: blob-spin-reverse 45s infinite linear;
            transform-origin: center;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
        }

        /* Dynamic Mesh Animations for Fullscreen Player */
        .fs-dynamic-mesh {
            transition: background-image 2s ease-in-out;
        }

        .fs-blob-1 {
            animation: blob-spin 25s infinite linear;
            transform-origin: center;
        }

        .fs-blob-2 {
            animation: blob-spin-reverse 30s infinite linear;
            transform-origin: center;
        }

        /* Advanced Shooting Stars Animation (kept, slightly less intense opacity) */
        .shooting-star {
            position: absolute;
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.85), transparent);
            animation: shooting-star-anim linear infinite;
            opacity: 0;
            transform: rotate(-45deg);
            filter: drop-shadow(0 0 6px rgba(255, 255, 255, 0.7));
            border-radius: 999px;
        }

        @keyframes shooting-star-anim {
            0% {
                transform: rotate(-45deg) translateX(-50vw);
                opacity: 0;
            }

            5% {
                opacity: 1;
            }

            15% {
                transform: rotate(-45deg) translateX(100vw);
                opacity: 0;
            }

            100% {
                transform: rotate(-45deg) translateX(100vw);
                opacity: 0;
            }
        }

        /* Varied Sizes, Speeds, and Delays for depth */
        .star-1 {
            top: 5%;
            left: 70%;
            width: 250px;
            height: 3px;
            animation-duration: 3s;
            animation-delay: 0s;
        }

        .star-2 {
            top: 30%;
            left: 80%;
            width: 120px;
            height: 1px;
            animation-duration: 6s;
            animation-delay: 1.5s;
        }

        .star-3 {
            top: 15%;
            left: 30%;
            width: 180px;
            height: 2px;
            animation-duration: 4.5s;
            animation-delay: 3.2s;
        }

        .star-4 {
            top: 60%;
            left: 90%;
            width: 300px;
            height: 4px;
            animation-duration: 2.5s;
            animation-delay: 2.1s;
        }

        .star-5 {
            top: -10%;
            left: 40%;
            width: 100px;
            height: 1px;
            animation-duration: 7s;
            animation-delay: 4.5s;
        }

        .star-6 {
            top: 40%;
            left: 10%;
            width: 150px;
            height: 2px;
            animation-duration: 5s;
            animation-delay: 0.8s;
        }

        .star-7 {
            top: 80%;
            left: 60%;
            width: 80px;
            height: 1px;
            animation-duration: 8s;
            animation-delay: 5s;
        }

        .star-8 {
            top: 25%;
            left: 95%;
            width: 220px;
            height: 3px;
            animation-duration: 3.5s;
            animation-delay: 2.7s;
        }

        .star-9 {
            top: 50%;
            left: 50%;
            width: 130px;
            height: 1px;
            animation-duration: 6.5s;
            animation-delay: 1.1s;
        }

        .star-10 {
            top: 70%;
            left: 20%;
            width: 190px;
            height: 2px;
            animation-duration: 4s;
            animation-delay: 3.8s;
        }

        .star-11 {
            top: -5%;
            left: 80%;
            width: 140px;
            height: 2px;
            animation-duration: 5.5s;
            animation-delay: 6s;
        }

        .star-12 {
            top: 85%;
            left: 90%;
            width: 280px;
            height: 4px;
            animation-duration: 2s;
            animation-delay: 4.2s;
        }

        /* Premium Glass Surfaces */
        .glass-panel {
            background: linear-gradient(180deg, rgba(255, 255, 255, .05), rgba(255, 255, 255, .02));
            backdrop-filter: blur(28px);
            -webkit-backdrop-filter: blur(28px);
            border: 1px solid var(--stroke);
            box-shadow: var(--shadow);
        }

        /* Premium media card system (replaces glass-card visually) */
        .media-card {
            background: linear-gradient(180deg, rgba(255, 255, 255, .05), rgba(255, 255, 255, .02));
            border: 1px solid var(--stroke);
            border-radius: var(--r-xl);
            padding: 12px;
            transition: transform .35s cubic-bezier(.2, .8, .2, 1), border-color .35s, background .35s, box-shadow .35s;
            will-change: transform;
            position: relative;
            overflow: hidden;
        }

        .media-card::before {
            content: "";
            position: absolute;
            inset: 0;
            background: radial-gradient(800px 400px at 20% 0%, rgba(255, 255, 255, .10), transparent 55%);
            opacity: .6;
            pointer-events: none;
        }

        .media-card:hover {
            transform: translateY(-6px);
            border-color: var(--stroke2);
            background: linear-gradient(180deg, rgba(255, 255, 255, .07), rgba(255, 255, 255, .03));
            box-shadow: var(--shadow2);
        }

        .media-art {
            border-radius: 18px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, .08);
            background: rgba(255, 255, 255, .04);
        }

        .play-fab {
            width: 48px;
            height: 48px;
            border-radius: 999px;
            background: rgba(255, 255, 255, .92);
            color: #05070a;
            box-shadow: 0 18px 45px rgba(0, 0, 0, .45), 0 0 0 1px rgba(0, 0, 0, .15) inset;
            transform: translateY(8px) scale(.92);
            opacity: 0;
            transition: all .25s cubic-bezier(.2, .8, .2, 1);
        }

        .media-card:hover .play-fab {
            transform: translateY(0) scale(1);
            opacity: 1;
        }

        /* Touch */
        .touch-effect:active {
            transform: scale(0.96) !important;
        }

        /* Lyrics mask + sync styling (kept, tuned) */
        .lyrics-mask {
            mask-image: linear-gradient(to bottom, transparent 0%, black 22%, black 78%, transparent 100%);
            -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 22%, black 78%, transparent 100%);
        }

        .lyric-line {
            transition: all 0.6s cubic-bezier(0.32, 0.72, 0, 1);
            transform-origin: center left;
            filter: blur(6px);
            opacity: 0.18;
            transform: scale(0.96);
        }

        .lyric-active {
            filter: blur(0px);
            opacity: 1;
            transform: scale(1.06);
            color: #ffffff;
            text-shadow: 0 0 30px var(--text-glow);
        }

        /* Structural Classes */
        .full-screen-hidden {
            opacity: 0;
            pointer-events: none;
            transform: translateY(15vh) scale(0.95);
        }

        .full-screen-visible {
            opacity: 1;
            pointer-events: auto;
            transform: none;
        }

        .bottom-player-hidden {
            transform: translateY(150%);
        }

        .bottom-player-visible {
            transform: translateY(0);
        }

        /* Nav polish: pill-like active, remove border-left feel */
        .nav-item {
            transition: background .2s ease, color .2s ease, transform .15s ease;
            cursor: pointer;
            border-left: 0 !important;
        }

        .nav-item:hover {
            color: white;
            background: rgba(255, 255, 255, .06);
        }

        .nav-active {
            color: white !important;
            background: rgba(255, 255, 255, .085) !important;
            font-weight: 800;
            border: 1px solid rgba(255, 255, 255, .10);
            box-shadow: 0 10px 30px rgba(0, 0, 0, .35) inset;
        }

        .nav-icon {
            transition: color .2s ease;
        }

        .nav-active .nav-icon {
            color: var(--accent) !important;
        }

        /* Sticky header transition surface (JS will toggle) */
        #top-header {
            transition: background .25s ease, backdrop-filter .25s ease, border-color .25s ease;
            border-bottom: 1px solid rgba(255, 255, 255, 0);
        }
    </style>
</head>

<body class="text-white font-sans overflow-hidden selection:bg-white/30 h-screen w-full relative">

    <!-- Global Advanced Shooting Stars Layer -->
    <div class="absolute inset-0 z-0 overflow-hidden pointer-events-none w-screen h-screen">
        <div class="shooting-star star-1"></div>
        <div class="shooting-star star-2"></div>
        <div class="shooting-star star-3"></div>
        <div class="shooting-star star-4"></div>
        <div class="shooting-star star-5"></div>
        <div class="shooting-star star-6"></div>
        <div class="shooting-star star-7"></div>
        <div class="shooting-star star-8"></div>
        <div class="shooting-star star-9"></div>
        <div class="shooting-star star-10"></div>
        <div class="shooting-star star-11"></div>
        <div class="shooting-star star-12"></div>
    </div>

    <!-- ========================================== -->
    <!-- LOGIN SCREEN -->
    <!-- ========================================== -->
    <div id="login-screen" class="absolute inset-0 z-50 flex items-center justify-center bg-[#05070a]">
        <div class="absolute inset-0 bg-gradient-to-br from-white/5 to-black blur-[100px] pointer-events-none"></div>

        <div
            class="glass-panel p-12 rounded-[2.5rem] max-w-md w-full text-center relative z-10 flex flex-col items-center shadow-2xl border border-white/10">
            <div
                class="w-24 h-24 rounded-[2rem] bg-white flex items-center justify-center shadow-[0_0_50px_rgba(255,255,255,0.3)] mb-8 transform rotate-3 hover:rotate-6 transition-transform duration-500">
                <svg class="w-12 h-12 text-black" viewBox="0 0 24 24" fill="currentColor"
                    xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm4.586 14.424c-.18.295-.562.383-.853.204-2.336-1.424-5.274-1.745-8.736-.955-.333.076-.66-.134-.736-.467-.076-.334.134-.66.467-.736 3.774-.863 7.02-.5 9.654 1.1.291.178.384.558.204.854zm1.226-2.732c-.226.368-.705.485-1.072.257-2.678-1.644-6.758-2.025-10.15-.11-.402.227-.905.084-1.13-.318-.225-.403-.083-.906.318-1.13 3.864-2.185 8.39-1.758 11.455.138.367.228.484.707.258 1.073zm.12-2.836c-3.197-1.895-8.472-2.07-11.536-1.144-.482.146-.99-.126-1.136-.607-.146-.48.125-.99.606-1.136 3.51-1.062 9.35-.86 13.04 1.317.425.25.568.8.318 1.225-.25.426-.802.568-1.226.318z" />
                </svg>
            </div>

            <h1 class="text-4xl font-extrabold mb-4 tracking-tight">Abhinav's Spotify</h1>
            <p class="text-white/50 mb-10 leading-relaxed text-sm">
                Connect your Spotify Premium account for a futuristic Spotify Ã— Apple Music experience.
            </p>

            <button onclick="loginWithSpotify()" id="login-btn"
                class="touch-effect w-full py-4 rounded-2xl bg-white text-black font-bold text-lg transition-all flex items-center justify-center gap-3 hover:scale-[1.02] shadow-[0_10px_30px_rgba(255,255,255,0.2)]">
                <i data-lucide="log-in" class="w-5 h-5"></i> Connect Spotify
            </button>
            <p id="login-status" class="text-white text-sm mt-4 hidden animate-pulse font-bold">Authenticating with
                server...</p>

            <div class="mt-8 p-4 bg-black/40 border border-white/5 rounded-2xl text-left w-full">
                <p class="text-white/70 text-xs font-bold uppercase tracking-wider mb-2">Setup Instructions</p>
                <code id="redirect-url-display"
                    class="block w-full p-3 bg-black/60 border border-white/10 rounded-xl text-xs text-white overflow-x-auto break-all select-all mb-3 font-mono"></code>
                <p class="text-white/50 text-xs">
                    Add this exact URL to your Spotify App <strong>Redirect URIs</strong> dashboard and save.
                </p>
            </div>
        </div>
    </div>

    <!-- ========================================== -->
    <!-- MAIN APPLICATION -->
    <!-- ========================================== -->
    <div id="main-app" class="hidden relative w-full h-full flex flex-col">

        <!-- Constant Deep Space Outer Background -->
        <div class="absolute inset-0 z-0 overflow-hidden pointer-events-none">
            <div class="absolute inset-0 opacity-30 mix-blend-screen transition-all duration-[2000ms]"
                id="mesh-container">
                <div
                    class="absolute -top-[20%] -left-[10%] w-[80vw] h-[80vw] rounded-full mesh-blob-1 blur-[140px] opacity-70">
                </div>
                <div
                    class="absolute -bottom-[10%] -right-[10%] w-[90vw] h-[90vw] rounded-full mesh-blob-2 blur-[160px] opacity-60">
                </div>
            </div>
            <div class="absolute inset-0 bg-[#05070a]/70 backdrop-blur-[70px]"></div>
        </div>

        <div class="relative z-10 flex h-full">

            <!-- Sidebar -->
            <div
                class="hidden md:flex flex-col w-[260px] py-6 px-4 glass-panel border-r border-white/5 z-20 shrink-0 shadow-[20px_0_50px_rgba(0,0,0,0.5)]">
                <div class="flex items-center gap-3 mb-6 px-2">
                    <div
                        class="w-8 h-8 rounded-lg bg-white flex items-center justify-center shadow-[0_0_15px_rgba(255,255,255,0.3)]">
                        <svg class="w-5 h-5 text-black" viewBox="0 0 24 24" fill="currentColor"
                            xmlns="http://www.w3.org/2000/svg">
                            <path
                                d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm4.586 14.424c-.18.295-.562.383-.853.204-2.336-1.424-5.274-1.745-8.736-.955-.333.076-.66-.134-.736-.467-.076-.334.134-.66.467-.736 3.774-.863 7.02-.5 9.654 1.1.291.178.384.558.204.854zm1.226-2.732c-.226.368-.705.485-1.072.257-2.678-1.644-6.758-2.025-10.15-.11-.402.227-.905.084-1.13-.318-.225-.403-.083-.906.318-1.13 3.864-2.185 8.39-1.758 11.455.138.367.228.484.707.258 1.073zm.12-2.836c-3.197-1.895-8.472-2.07-11.536-1.144-.482.146-.99-.126-1.136-.607-.146-.48.125-.99.606-1.136 3.51-1.062 9.35-.86 13.04 1.317.425.25.568.8.318 1.225-.25.426-.802.568-1.226.318z" />
                        </svg>
                    </div>
                    <span class="text-lg font-extrabold tracking-tight">Abhinav's Spotify</span>
                </div>

                <div class="space-y-6 flex-1 overflow-y-auto hide-scrollbar">
                    <div class="mb-4 mt-2">
                        <div id="nav-search" onclick="navigate('search')"
                            class="touch-effect nav-item flex items-center gap-3 px-3 py-2.5 rounded-xl bg-white/5 border border-white/5 hover:bg-white/10 group shadow-inner">
                            <i data-lucide="search" class="nav-icon w-5 h-5 text-white/50"></i>
                            <span class="font-bold text-[15px] text-white/90">Search</span>
                        </div>
                    </div>

                    <div class="space-y-1">
                        <div id="nav-home" onclick="navigate('home')"
                            class="touch-effect nav-item nav-active flex items-center gap-3 px-3 py-2 rounded-lg text-white/70">
                            <i data-lucide="home" class="nav-icon w-5 h-5"></i>
                            <span class="font-medium text-[15px]">Home</span>
                        </div>
                        <div id="nav-new" onclick="navigate('new')"
                            class="touch-effect nav-item flex items-center gap-3 px-3 py-2 rounded-lg text-white/70">
                            <i data-lucide="layout-grid" class="nav-icon w-5 h-5"></i>
                            <span class="font-medium text-[15px]">New Releases</span>
                        </div>
                        <div id="nav-radio" onclick="navigate('radio')"
                            class="touch-effect nav-item flex items-center gap-3 px-3 py-2 rounded-lg text-white/70">
                            <i data-lucide="radio" class="nav-icon w-5 h-5"></i>
                            <span class="font-medium text-[15px]">Radio</span>
                        </div>
                    </div>

                    <div class="space-y-1">
                        <p class="text-[11px] font-bold text-white/40 mb-2 px-3 tracking-widest uppercase">Library</p>
                        <div id="nav-recently_played" onclick="navigate('recently_played')"
                            class="touch-effect nav-item flex items-center gap-3 px-3 py-2 rounded-lg text-white/70">
                            <i data-lucide="clock" class="nav-icon w-5 h-5"></i>
                            <span class="font-medium text-[15px]">Recently Played</span>
                        </div>
                        <div id="nav-artists" onclick="navigate('artists')"
                            class="touch-effect nav-item flex items-center gap-3 px-3 py-2 rounded-lg text-white/70">
                            <i data-lucide="mic-2" class="nav-icon w-5 h-5"></i>
                            <span class="font-medium text-[15px]">Artists</span>
                        </div>
                        <div id="nav-albums" onclick="navigate('albums')"
                            class="touch-effect nav-item flex items-center gap-3 px-3 py-2 rounded-lg text-white/70">
                            <i data-lucide="layers" class="nav-icon w-5 h-5"></i>
                            <span class="font-medium text-[15px]">Albums</span>
                        </div>
                        <div id="nav-songs" onclick="navigate('songs')"
                            class="touch-effect nav-item flex items-center gap-3 px-3 py-2 rounded-lg text-white/70">
                            <i data-lucide="music-4" class="nav-icon w-5 h-5"></i>
                            <span class="font-medium text-[15px]">Songs</span>
                        </div>
                    </div>

                    <div class="space-y-1 pb-4">
                        <p class="text-[11px] font-bold text-white/40 mb-2 px-3 tracking-widest uppercase">Playlists</p>
                        <div id="nav-all_playlists" onclick="navigate('all_playlists')"
                            class="touch-effect nav-item flex items-center gap-3 px-3 py-2 rounded-lg text-white/70">
                            <i data-lucide="layout-dashboard" class="nav-icon w-5 h-5"></i>
                            <span class="font-medium text-[15px]">All Playlists</span>
                        </div>
                        <div id="nav-favourite_songs" onclick="navigate('favourite_songs')"
                            class="touch-effect nav-item flex items-center gap-3 px-3 py-2 rounded-lg text-white/70">
                            <i data-lucide="star" class="nav-icon w-5 h-5"></i>
                            <span class="font-medium text-[15px]">Favourite Songs</span>
                        </div>
                    </div>
                </div>

                <!-- Bottom Profile Area -->
                <div class="mt-auto pt-4 border-t border-white/5">
                    <div onclick="logout()"
                        class="touch-effect flex items-center gap-3 p-2 rounded-xl hover:bg-white/10 transition-all cursor-pointer">
                        <img id="user-avatar" src="https://i.pravatar.cc/100" alt="Profile"
                            class="w-8 h-8 rounded-full hidden" />
                        <div id="user-initial"
                            class="w-8 h-8 rounded-full bg-white flex items-center justify-center text-xs font-bold text-black">
                            U</div>
                        <div class="flex flex-col overflow-hidden">
                            <span id="user-name" class="text-[13px] font-bold truncate text-white/90">Spotify
                                User</span>
                            <span
                                class="text-[10px] uppercase tracking-wider text-white/40 hover:text-white transition-colors">Sign
                                Out</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Center Content Area -->
            <div class="flex-1 flex flex-col h-full overflow-hidden">

                <!-- Floating Header / Live Search -->
                <div id="top-header" class="h-24 flex items-center justify-between px-6 md:px-10 shrink-0 w-full z-30">
                    <div id="top-search-bar" class="w-full max-w-xl transition-all">
                        <form onsubmit="event.preventDefault();" class="relative w-full group">
                            <div class="absolute inset-y-0 left-5 flex items-center pointer-events-none">
                                <i data-lucide="search"
                                    class="w-5 h-5 text-white/40 group-focus-within:text-white transition-colors"></i>
                            </div>
                            <input id="search-input" oninput="handleLiveSearch(event)" type="text"
                                placeholder="Live Search Tracks, Albums, Playlists..."
                                class="w-full bg-white/5 border border-white/10 text-white placeholder-white/30 rounded-2xl py-3.5 pl-14 pr-6 focus:outline-none focus:ring-2 focus:ring-white/30 focus:bg-white/10 transition-all backdrop-blur-xl text-[15px] font-semibold shadow-[0_10px_30px_rgba(0,0,0,0.3)]" />
                        </form>
                    </div>
                    <div class="flex-1"></div>
                    <div id="sdk-status"
                        class="flex items-center gap-2 text-white/50 text-[11px] uppercase tracking-widest font-bold bg-white/5 px-4 py-2 rounded-lg border border-white/10">
                        <i data-lucide="loader-2" class="w-3.5 h-3.5 animate-spin"></i> Engine Setup...
                    </div>
                </div>

                <!-- Main Music Grid -->
                <div id="main-scroll"
                    class="flex-1 overflow-y-auto hide-scrollbar pretty-scrollbar px-6 md:px-10 pb-52 pt-2 relative z-10">
                    <h1 id="results-title"
                        class="text-[2.2rem] md:text-[2.6rem] font-extrabold mb-6 tracking-tighter text-white drop-shadow-lg">
                        Home</h1>

                    <div id="loading-spinner" class="hidden flex space-x-2 justify-center items-center h-40">
                        <div class="w-3 h-3 bg-white rounded-full animate-bounce" style="animation-delay:-0.3s"></div>
                        <div class="w-3 h-3 bg-white/70 rounded-full animate-bounce" style="animation-delay:-0.15s">
                        </div>
                        <div class="w-3 h-3 bg-white/40 rounded-full animate-bounce"></div>
                    </div>

                    <div id="search-results-grid"
                        class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 2xl:grid-cols-6 gap-6">
                        <!-- Content injected here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- ========================================== -->
        <!-- FLOATING BOTTOM PLAYER -->
        <!-- ========================================== -->
        <div id="bottom-player"
            class="bottom-player-hidden absolute bottom-6 left-6 md:left-[284px] right-6 z-40 transition-transform duration-[800ms] ease-[cubic-bezier(0.25,1,0.5,1)]">
            <div class="max-w-[1600px] mx-auto glass-panel rounded-[1.5rem] p-3 flex items-center justify-between gap-6 shadow-[0_30px_60px_rgba(0,0,0,0.6)] relative overflow-hidden group cursor-pointer border border-white/10"
                onclick="if(event.target.tagName !== 'I' && event.target.tagName !== 'BUTTON') toggleFullScreen(true)">

                <div class="absolute top-0 inset-x-0 h-[2px] bg-white/5">
                    <div id="mini-progress"
                        class="h-full bg-white shadow-[0_0_10px_rgba(255,255,255,0.8)] transition-all duration-[100ms] ease-linear"
                        style="width: 0%"></div>
                </div>

                <div class="flex items-center gap-4 w-1/3 min-w-[200px] pl-2">
                    <div class="relative w-[52px] h-[52px] rounded-lg overflow-hidden shadow-md border border-white/5">
                        <img id="mini-art" src="" alt="cover" class="w-full h-full object-cover" />
                    </div>
                    <div class="flex flex-col truncate">
                        <span id="mini-title"
                            class="font-extrabold text-white text-[15px] truncate tracking-tight drop-shadow-md">Track
                            Name</span>
                        <span id="mini-artist" class="text-[13px] text-white/60 truncate font-semibold mt-0.5">Artist
                            Name</span>
                    </div>
                </div>

                <div class="flex flex-col items-center gap-2 w-1/3">
                    <div class="flex items-center gap-8">
                        <i data-lucide="skip-back"
                            class="w-5 h-5 text-white/70 hover:text-white hover:scale-110 cursor-pointer transition-all"
                            onclick="skipPrev(); event.stopPropagation();"></i>
                        <button onclick="togglePlay(); event.stopPropagation();"
                            class="touch-effect w-11 h-11 rounded-full bg-white hover:scale-105 transition-all shadow-[0_0_20px_rgba(255,255,255,0.3)] flex items-center justify-center">
                            <i id="mini-play-icon" data-lucide="play" fill="black" class="text-black w-5 h-5 ml-1"></i>
                        </button>
                        <i data-lucide="skip-forward"
                            class="w-5 h-5 text-white/70 hover:text-white hover:scale-110 cursor-pointer transition-all"
                            onclick="skipNext(); event.stopPropagation();"></i>
                    </div>
                </div>

                <div class="flex items-center justify-end gap-6 w-1/3 pr-4">
                    <div
                        class="hidden md:flex items-center gap-2 border border-white/20 bg-white/5 rounded-md px-2 py-1 shadow-sm">
                        <i data-lucide="high-definition" class="w-3.5 h-3.5 text-white"></i>
                        <span class="text-[10px] font-extrabold text-white uppercase tracking-widest">Lossless</span>
                    </div>

                    <button onclick="toggleFullScreen(true); event.stopPropagation();"
                        class="p-2 rounded-full hover:bg-white/10 text-white/70 hover:text-white transition-colors hover:scale-110 touch-effect">
                        <i data-lucide="maximize-2" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- ========================================== -->
        <!-- MASSIVE FULL SCREEN PLAYER OVERLAY -->
        <!-- ========================================== -->
        <div id="fullscreen-player"
            class="full-screen-hidden fixed inset-0 z-50 flex flex-col transition-all duration-[800ms] ease-[cubic-bezier(0.25,1,0.5,1)] bg-black w-screen h-screen">

            <div class="absolute inset-0 z-0 overflow-hidden pointer-events-none w-full h-full">
                <div class="shooting-star star-1" style="z-index: 1;"></div>
                <div class="shooting-star star-2" style="z-index: 1;"></div>
                <div class="shooting-star star-3" style="z-index: 1;"></div>
                <div class="shooting-star star-5" style="z-index: 1;"></div>
                <div class="shooting-star star-8" style="z-index: 1;"></div>
                <div class="shooting-star star-12" style="z-index: 1;"></div>

                <div class="absolute inset-0 opacity-80 mix-blend-screen saturate-[2.0] transition-all duration-[2000ms]"
                    id="fs-mesh-container">
                    <div id="fs-mesh-1"
                        class="absolute -top-[10%] -left-[10%] w-[120vw] h-[120vh] rounded-full fs-dynamic-mesh fs-blob-1 blur-[140px] opacity-80 bg-cover bg-center">
                    </div>
                    <div id="fs-mesh-2"
                        class="absolute top-[20%] -right-[20%] w-[120vw] h-[120vh] rounded-full fs-dynamic-mesh fs-blob-2 blur-[160px] opacity-70 bg-cover bg-center">
                    </div>
                </div>
                <div class="absolute inset-0 bg-[#05070a]/70 backdrop-blur-[80px]"></div>
            </div>

            <!-- Top Action Bar -->
            <div class="relative z-10 flex items-center justify-between p-8 shrink-0 w-full">
                <button onclick="toggleFullScreen(false)"
                    class="touch-effect w-12 h-12 rounded-full bg-white/5 hover:bg-white/15 backdrop-blur-xl flex items-center justify-center transition-all hover:scale-105 border border-white/10 shadow-lg">
                    <i data-lucide="chevron-down" class="w-6 h-6 text-white"></i>
                </button>

                <div class="flex bg-white/5 backdrop-blur-2xl rounded-full p-1 border border-white/10 shadow-xl">
                    <button onclick="switchFsView('artwork')" id="btn-artwork"
                        class="bg-white/20 shadow-lg text-white px-8 py-2 rounded-full text-[13px] font-extrabold transition-all tracking-wide">
                        Playing
                    </button>
                    <button onclick="switchFsView('lyrics')" id="btn-lyrics"
                        class="text-white/60 hover:text-white px-8 py-2 rounded-full text-[13px] font-extrabold transition-all flex items-center gap-2 tracking-wide">
                        <i data-lucide="mic-2" class="w-4 h-4"></i> Lyrics
                    </button>
                    <button onclick="switchFsView('insights')" id="btn-insights"
                        class="text-white/60 hover:text-white px-8 py-2 rounded-full text-[13px] font-extrabold transition-all flex items-center gap-2 tracking-wide">
                        <i id="sparkles-icon" data-lucide="sparkles" class="w-4 h-4"></i> AI
                    </button>
                </div>

                <div
                    class="h-10 px-3.5 rounded-lg bg-white/10 border border-white/20 flex items-center gap-2 shadow-lg backdrop-blur-md">
                    <i data-lucide="high-definition" class="w-3.5 h-3.5 text-white"></i>
                    <span class="text-[10px] font-extrabold text-white uppercase tracking-widest">Lossless</span>
                </div>
            </div>

            <!-- Split layout -->
            <div
                class="relative z-10 flex-1 flex flex-row items-center justify-between max-w-[1800px] mx-auto w-full h-full overflow-hidden px-10 gap-0">

                <div id="fs-art-container"
                    class="flex flex-col transition-all duration-[800ms] ease-[cubic-bezier(0.25,1,0.5,1)] items-center justify-center w-full">
                    <div id="fs-art-wrapper"
                        class="relative rounded-[2rem] overflow-hidden shadow-[0_40px_80px_rgba(0,0,0,0.7)] transition-all duration-[800ms] ease-[cubic-bezier(0.25,1,0.5,1)] w-[45vh] h-[45vh] lg:w-[50vh] lg:h-[50vh] max-w-[600px] max-h-[600px] border border-white/5">
                        <img id="fs-art" src="" class="w-full h-full object-cover" alt="cover big" />
                        <div
                            class="absolute inset-0 bg-gradient-to-tr from-white/10 to-transparent mix-blend-overlay pointer-events-none">
                        </div>
                    </div>
                    <div id="fs-meta"
                        class="mt-10 flex flex-col transition-all duration-[800ms] items-center text-center opacity-100">
                        <h2 id="fs-title"
                            class="text-3xl sm:text-5xl font-extrabold text-white mb-2 tracking-tighter drop-shadow-xl">
                            Track Name</h2>
                        <p id="fs-artist"
                            class="text-xl sm:text-2xl text-white/60 font-bold tracking-tight drop-shadow-md">Artist
                            Name</p>
                    </div>
                </div>

                <div id="fs-side-panel"
                    class="w-0 opacity-0 overflow-hidden transition-all duration-[800ms] ease-[cubic-bezier(0.25,1,0.5,1)] flex flex-col justify-center h-[85vh] shrink-0">

                    <!-- Lyrics -->
                    <div id="fs-lyrics-panel" class="hidden relative w-full h-full lyrics-mask overflow-hidden">
                        <div id="lyrics-container"
                            class="w-full h-full overflow-y-auto hide-scrollbar scroll-smooth pt-[40vh] pb-[40vh] pl-24 pr-4 text-left">
                            <p class="text-white/40 text-2xl font-bold mt-20 animate-pulse">Loading synced lyrics...</p>
                        </div>
                    </div>

                    <!-- Gemini AI Insights -->
                    <div id="fs-insights-panel" class="hidden w-full h-full flex-col justify-center pl-24 pr-4">
                        <div
                            class="p-12 glass-panel rounded-[2.5rem] bg-gradient-to-br from-white/5 to-transparent border border-white/10 shadow-2xl relative overflow-hidden">
                            <div
                                class="absolute -top-24 -right-24 w-64 h-64 bg-white opacity-20 rounded-full blur-[80px] pointer-events-none transition-all duration-1000">
                            </div>

                            <div class="flex items-center gap-4 mb-10 relative z-10">
                                <div class="w-14 h-14 rounded-2xl bg-white flex items-center justify-center shadow-lg">
                                    <i data-lucide="sparkles" class="w-7 h-7 text-black"></i>
                                </div>
                                <h3 class="text-4xl font-extrabold tracking-tight text-white drop-shadow-md">Track DNA
                                </h3>
                            </div>

                            <div id="gemini-key-setup" class="hidden relative z-10 w-full mb-4">
                                <p class="text-white/60 mb-4 font-medium text-sm">Please securely enter your Google
                                    Gemini API Key to unlock real-time AI context.</p>
                                <input id="gemini-key-input" type="password" placeholder="AIzaSy..."
                                    class="w-full bg-black/50 border border-white/20 text-white rounded-xl py-3.5 px-5 focus:outline-none focus:border-white mb-4 text-sm" />
                                <button onclick="saveGeminiKey()"
                                    class="touch-effect w-full py-3.5 rounded-xl bg-white text-black font-extrabold shadow-lg transition-transform">Initialize
                                    AI</button>
                            </div>

                            <p id="ai-insight-text"
                                class="text-2xl lg:text-3xl font-bold leading-snug text-white/90 relative z-10 tracking-tight drop-shadow-md">
                                Analyzing audio composition framework...
                            </p>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Fullscreen Controls -->
            <div class="relative z-10 w-full max-w-3xl mx-auto px-8 pb-10 flex flex-col gap-6 shrink-0">
                <div class="flex items-center gap-4 text-[11px] font-bold text-white/50 tracking-widest">
                    <span id="fs-current-time" class="w-10 text-right">0:00</span>
                    <div class="h-[2px] flex-1 bg-white/20 rounded-full overflow-hidden relative cursor-pointer group">
                        <div id="fs-progress"
                            class="absolute top-0 left-0 h-full bg-white shadow-[0_0_15px_rgba(255,255,255,0.8)] transition-all duration-[100ms] ease-linear"
                            style="width: 0%"></div>
                    </div>
                    <span id="fs-total-time" class="w-10">0:00</span>
                </div>

                <div class="flex items-center justify-center gap-10">
                    <button class="touch-effect text-white/40 hover:text-white transition-colors"><i
                            data-lucide="shuffle" class="w-5 h-5"></i></button>

                    <div class="flex items-center gap-8">
                        <i data-lucide="skip-back"
                            class="w-7 h-7 text-white/90 hover:text-white cursor-pointer hover:scale-110 active:scale-95 transition-all"
                            onclick="skipPrev()"></i>

                        <button onclick="togglePlay()"
                            class="touch-effect w-[60px] h-[60px] rounded-full bg-white text-black flex items-center justify-center hover:scale-105 active:scale-95 transition-all shadow-[0_0_40px_rgba(255,255,255,0.4)]">
                            <i id="fs-play-icon" data-lucide="play" fill="black" class="w-6 h-6 ml-1.5"></i>
                        </button>

                        <i data-lucide="skip-forward"
                            class="w-7 h-7 text-white/90 hover:text-white cursor-pointer hover:scale-110 active:scale-95 transition-all"
                            onclick="skipNext()"></i>
                    </div>

                    <button class="touch-effect text-white/40 hover:text-white transition-colors"><i
                            data-lucide="repeat" class="w-5 h-5"></i></button>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================== -->
    <!-- JAVASCRIPT LOGIC -->
    <!-- ========================================== -->
    <script>
        // ðŸŸ¢ SPOTIFY CONFIGURATION
        const SPOTIFY_CLIENT_ID = '1f795749eca84eec8a0f07d355216a17';
        const REDIRECT_URI = window.location.hostname.includes('lnch.in')
            ? 'https://lnch.in/dash/callback'
            : window.location.origin + window.location.pathname;

        const SCOPES = [
            'streaming', 'user-read-email', 'user-read-private',
            'user-read-playback-state', 'user-modify-playback-state', 'user-library-read',
            'user-top-read', 'user-follow-read', 'playlist-read-private', 'user-read-recently-played'
        ].join(' ');

        document.getElementById('redirect-url-display').innerText = REDIRECT_URI;
        lucide.createIcons();

        // State variables
        let token = null;
        let player = null;
        let deviceId = null;
        let currentTrack = null;
        let currentTrackId = null;
        let isPlaying = false;
        let currentTime = 0;
        let duration = 0;

        let progressInterval = null;
        let lastTickTime = 0;

        let activeNav = 'home';
        let activeFsView = 'artwork';

        let parsedLyrics = [];
        let currentLyricIndex = -1;

        // PKCE Auth Helpers
        function generateRandomString(length) {
            let text = '';
            const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            for (let i = 0; i < length; i++) text += possible.charAt(Math.floor(Math.random() * possible.length));
            return text;
        }
        async function generateCodeChallenge(codeVerifier) {
            const encoder = new TextEncoder();
            const data = encoder.encode(codeVerifier);
            const digest = await window.crypto.subtle.digest('SHA-256', data);
            return btoa(String.fromCharCode.apply(null, [...new Uint8Array(digest)]))
                .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
        }

        // Init
        window.onload = async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            let localToken = window.localStorage.getItem('spotify_token');

            if (code && !localToken) {
                document.getElementById('login-btn').classList.add('hidden');
                document.getElementById('login-status').classList.remove('hidden');

                const codeVerifier = window.localStorage.getItem('code_verifier');
                const body = new URLSearchParams({
                    grant_type: 'authorization_code', code: code, redirect_uri: REDIRECT_URI,
                    client_id: SPOTIFY_CLIENT_ID, code_verifier: codeVerifier
                });

                try {
                    const response = await fetch('https://accounts.spotify.com/api/token', {
                        method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: body
                    });
                    if (!response.ok) throw new Error('Token fetch failed');
                    const data = await response.json();
                    localToken = data.access_token;
                    window.localStorage.setItem('spotify_token', localToken);
                    window.history.replaceState({}, document.title, window.location.pathname);
                } catch (e) {
                    document.getElementById('login-btn').classList.remove('hidden');
                    document.getElementById('login-status').classList.add('hidden');
                }
            }

            if (localToken) {
                token = localToken;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                fetchUserProfile();
                initSpotifyPlayer();
                navigate('home');
                setupStickyHeader(); // âœ… premium sticky blur
            }
        };

        async function loginWithSpotify() {
            const codeVerifier = generateRandomString(128);
            window.localStorage.setItem('code_verifier', codeVerifier);
            const codeChallenge = await generateCodeChallenge(codeVerifier);
            const params = new URLSearchParams({
                client_id: SPOTIFY_CLIENT_ID, response_type: 'code', redirect_uri: REDIRECT_URI,
                scope: SCOPES, code_challenge_method: 'S256', code_challenge: codeChallenge
            });
            window.location.href = `https://accounts.spotify.com/authorize?${params.toString()}`;
        }

        function logout() {
            window.localStorage.removeItem('spotify_token');
            if (player) player.disconnect();
            location.reload();
        }

        async function fetchAPI(endpoint) {
            const res = await fetch(`https://api.spotify.com/v1${endpoint}`, { headers: { Authorization: `Bearer ${token}` } });
            if (res.status === 401) return logout();
            return await res.json();
        }

        async function fetchUserProfile() {
            try {
                const data = await fetchAPI('/me');
                document.getElementById('user-name').innerText = data.display_name || 'Spotify User';
                if (data.images?.[0]) {
                    document.getElementById('user-avatar').src = data.images[0].url;
                    document.getElementById('user-avatar').classList.remove('hidden');
                    document.getElementById('user-initial').classList.add('hidden');
                }
            } catch (err) { }
        }

        // âœ… Premium sticky header blur on scroll (Apple-ish)
        function setupStickyHeader() {
            const scroller = document.getElementById('main-scroll');
            const header = document.getElementById('top-header');
            if (!scroller || !header) return;

            const apply = () => {
                const y = scroller.scrollTop || 0;
                header.style.background = y > 12 ? 'rgba(5,7,10,.55)' : 'transparent';
                header.style.backdropFilter = y > 12 ? 'blur(20px)' : 'none';
                header.style.borderBottom = y > 12 ? '1px solid rgba(255,255,255,.08)' : '1px solid rgba(255,255,255,0)';
            };

            scroller.addEventListener('scroll', apply, { passive: true });
            apply();
        }

        // ==========================================
        // SMART NAVIGATION ENGINE (WITH BULLETPROOF FALLBACKS)
        // ==========================================
        async function navigate(view, skipFetch = false) {
            activeNav = view;
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('nav-active'));
            const activeItem = document.getElementById(`nav-${view}`);
            if (activeItem) activeItem.classList.add('nav-active');

            if (view === 'search') document.getElementById('search-input').focus();
            if (skipFetch) return;

            const grid = document.getElementById('search-results-grid');
            grid.innerHTML = '';
            document.getElementById('loading-spinner').classList.remove('hidden');

            let displayTitle = view.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
            if (view === 'search') displayTitle = "Search Spotify";

            if (view === 'home') {
                const hour = new Date().getHours();
                displayTitle = hour < 12 ? 'Good Morning' : hour < 18 ? 'Good Afternoon' : 'Good Evening';
            }
            document.getElementById('results-title').innerText = displayTitle;

            try {
                let data;

                if (view === 'home') {
                    data = await fetchAPI('/me/top/tracks?limit=24');
                    if (data.items && data.items.length > 0) { renderTracks(data.items); }
                    else {
                        data = await fetchAPI('/browse/featured-playlists?limit=24');
                        if (data.playlists) renderAlbumsPlaylists(data.playlists.items, 'playlist');
                    }
                }
                else if (view === 'new') {
                    data = await fetchAPI('/browse/new-releases?limit=24');
                    if (data.albums?.items?.length > 0) renderAlbumsPlaylists(data.albums.items, 'album');
                    else renderEmptyState("New releases unavailable.");
                }
                else if (view === 'radio') {
                    data = await fetchAPI('/browse/featured-playlists?limit=24');
                    if (data.playlists?.items?.length > 0) renderAlbumsPlaylists(data.playlists.items, 'playlist');
                    else renderEmptyState("Radio unavailable.");
                }
                else if (view === 'recently_played') {
                    data = await fetchAPI('/me/player/recently-played?limit=24');
                    if (data.items && data.items.length > 0) { renderTracks(data.items.map(item => item.track)); }
                    else {
                        data = await fetchAPI('/me/top/tracks?limit=24');
                        if (data.items && data.items.length > 0) renderTracks(data.items);
                        else renderEmptyState("No recent history. Start listening!");
                    }
                }
                else if (view === 'songs') {
                    data = await fetchAPI('/me/tracks?limit=50');
                    if (data.items && data.items.length > 0) { renderTracks(data.items.map(item => item.track)); }
                    else {
                        data = await fetchAPI('/me/top/tracks?limit=24');
                        if (data.items && data.items.length > 0) renderTracks(data.items);
                        else renderEmptyState("Your liked songs will appear here.");
                    }
                }
                else if (view === 'artists') {
                    data = await fetchAPI('/me/following?type=artist&limit=24');
                    if (data.artists?.items?.length > 0) { renderArtists(data.artists.items); }
                    else {
                        data = await fetchAPI('/search?q=year:2024&type=artist&limit=24');
                        if (data.artists) renderArtists(data.artists.items);
                    }
                }
                else if (view === 'albums') {
                    data = await fetchAPI('/me/albums?limit=24');
                    if (data.items && data.items.length > 0) { renderAlbumsPlaylists(data.items.map(item => item.album), 'album'); }
                    else {
                        data = await fetchAPI('/browse/new-releases?limit=24');
                        if (data.albums) renderAlbumsPlaylists(data.albums.items, 'album');
                    }
                }
                else if (view === 'all_playlists' || view === 'favourite_songs') {
                    data = await fetchAPI('/me/playlists?limit=24');
                    if (data.items && data.items.length > 0) { renderAlbumsPlaylists(data.items, 'playlist'); }
                    else {
                        data = await fetchAPI('/browse/featured-playlists?limit=24');
                        if (data.playlists) renderAlbumsPlaylists(data.playlists.items, 'playlist');
                    }
                }

            } catch (e) { console.error(e); }

            document.getElementById('loading-spinner').classList.add('hidden');
        }

        function renderEmptyState(msg) {
            const grid = document.getElementById('search-results-grid');
            grid.innerHTML = `
        <div class="col-span-full flex flex-col items-center justify-center py-20 opacity-60">
          <i data-lucide="sparkles" class="w-12 h-12 mb-4 text-white"></i>
          <p class="text-xl font-extrabold text-white/90">${msg}</p>
          <p class="text-sm mt-2 text-white/45 font-semibold">Try searching for new music.</p>
        </div>`;
            lucide.createIcons();
        }

        // ==========================================
        // LIVE SEARCH ENGINE
        // ==========================================
        let liveSearchTimeout;
        function handleLiveSearch(e) {
            clearTimeout(liveSearchTimeout);
            const q = e.target.value;
            if (q.trim().length > 0) {
                liveSearchTimeout = setTimeout(() => {
                    if (activeNav !== 'search') navigate('search', true);
                    performSearch(q);
                }, 350);
            } else if (q.trim().length === 0 && activeNav === 'search') {
                document.getElementById('search-results-grid').innerHTML = '';
            }
        }

        async function performSearch(query) {
            document.getElementById('loading-spinner').classList.remove('hidden');
            document.getElementById('search-results-grid').innerHTML = '';
            document.getElementById('results-title').innerText = `Results for "${query}"`;
            try {
                const data = await fetchAPI(`/search?q=${encodeURIComponent(query)}&type=track&limit=24`);
                renderTracks(data.tracks.items);
            } catch (e) { console.error(e); }
            document.getElementById('loading-spinner').classList.add('hidden');
        }

        // ==========================================
        // PREMIUM RENDERING (Updated Cards)
        // ==========================================
        function renderTracks(tracks) {
            let html = '';
            tracks.forEach(song => {
                if (!song) return;
                const art = song.album?.images?.[0]?.url || 'https://via.placeholder.com/300';
                const artist = song.artists?.[0]?.name || 'Unknown';

                html += `
          <div onclick="playItem('${song.uri}', 'track')" class="media-card group cursor-pointer flex flex-col gap-3">
            <div class="relative aspect-square media-art">
              <img src="${art}" class="w-full h-full object-cover group-hover:scale-[1.06] transition-transform duration-[900ms] ease-out" />
              <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-black/10 to-transparent opacity-80"></div>
              <div class="absolute bottom-3 right-3 flex items-center gap-2">
                <div class="play-fab flex items-center justify-center">
                  <i data-lucide="play" fill="black" class="w-5 h-5 ml-0.5"></i>
                </div>
              </div>
            </div>
            <div class="px-1">
              <h3 class="font-extrabold text-[13.5px] tracking-tight truncate text-white">${song.name}</h3>
              <p class="text-[12px] font-semibold text-white/50 truncate mt-0.5">${artist}</p>
            </div>
          </div>
        `;
            });

            document.getElementById('search-results-grid').innerHTML = html;
            lucide.createIcons();
        }

        function renderAlbumsPlaylists(items, type) {
            let html = '';
            items.filter(Boolean).forEach(item => {
                const art = item.images?.[0]?.url || 'https://via.placeholder.com/300';
                const subtitle = type === 'album'
                    ? (item.artists?.[0]?.name || 'Album')
                    : `By ${item.owner?.display_name || 'Unknown'}`;

                html += `
          <div onclick="playItem('${item.uri}', '${type}')" class="media-card group cursor-pointer flex flex-col gap-3">
            <div class="relative aspect-square media-art">
              <img src="${art}" class="w-full h-full object-cover group-hover:scale-[1.06] transition-transform duration-[900ms] ease-out" />
              <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-black/10 to-transparent opacity-80"></div>
              <div class="absolute bottom-3 right-3">
                <div class="play-fab flex items-center justify-center">
                  <i data-lucide="play" fill="black" class="w-5 h-5 ml-0.5"></i>
                </div>
              </div>
            </div>
            <div class="px-1">
              <h3 class="font-extrabold text-[13.5px] tracking-tight truncate text-white">${item.name}</h3>
              <p class="text-[12px] font-semibold text-white/50 truncate mt-0.5">${subtitle}</p>
            </div>
          </div>
        `;
            });

            document.getElementById('search-results-grid').innerHTML = html;
            lucide.createIcons();
        }

        function renderArtists(artists) {
            let html = '';
            artists.forEach(artist => {
                if (!artist) return;
                const art = artist.images?.[0]?.url || 'https://via.placeholder.com/300';

                html += `
          <div onclick="playArtistTopTracks('${artist.id}')" class="media-card group cursor-pointer flex flex-col items-center gap-3">
            <div class="relative w-full aspect-square rounded-[999px] overflow-hidden border border-white/10 bg-white/5">
              <img src="${art}" class="w-full h-full object-cover group-hover:scale-[1.06] transition-transform duration-[900ms] ease-out" />
              <div class="absolute inset-0 bg-gradient-to-t from-black/50 via-black/10 to-transparent opacity-80"></div>
              <div class="absolute bottom-3 right-3">
                <div class="play-fab flex items-center justify-center">
                  <i data-lucide="play" fill="black" class="w-5 h-5 ml-0.5"></i>
                </div>
              </div>
            </div>
            <div class="text-center w-full px-2">
              <h3 class="font-extrabold text-[13.5px] tracking-tight truncate text-white">${artist.name}</h3>
              <p class="text-[10px] font-extrabold text-white/35 uppercase tracking-[0.22em] mt-1">Artist</p>
            </div>
          </div>
        `;
            });

            document.getElementById('search-results-grid').innerHTML = html;
            lucide.createIcons();
        }

        // ==========================================
        // WEB PLAYBACK SDK
        // ==========================================
        function initSpotifyPlayer() {
            const script = document.createElement('script');
            script.src = 'https://sdk.scdn.co/spotify-player.js';
            script.async = true;
            document.body.appendChild(script);

            window.onSpotifyWebPlaybackSDKReady = () => {
                player = new window.Spotify.Player({
                    name: "Abhinav's Spotify Web Player", getOAuthToken: cb => { cb(token); }, volume: 0.8
                });

                player.addListener('ready', ({ device_id }) => {
                    deviceId = device_id;
                    const statusEl = document.getElementById('sdk-status');
                    statusEl.className = "flex items-center gap-2 text-white/90 text-[11px] uppercase tracking-widest font-extrabold bg-white/10 px-4 py-2 rounded-lg border border-white/20";
                    statusEl.innerHTML = `<i data-lucide="check" class="w-3.5 h-3.5"></i> Connected`;
                    lucide.createIcons();
                    setTimeout(() => statusEl.classList.add('opacity-0'), 4000);
                });

                player.addListener('player_state_changed', state => {
                    if (!state) return;
                    currentTrack = state.track_window.current_track;
                    isPlaying = !state.paused;

                    duration = state.duration;
                    currentTime = state.position;
                    lastTickTime = performance.now();

                    updatePlayerUI();
                    startProgressTimer();
                });

                player.connect();
            };
        }

        async function playItem(uri, type) {
            if (!deviceId || !token) return;
            const body = type === 'track' ? { uris: [uri] } : { context_uri: uri };
            await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${deviceId}`, {
                method: 'PUT', headers: { Authorization: `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
        }

        async function playArtistTopTracks(artistId) {
            if (!deviceId || !token) return;
            const data = await fetchAPI(`/artists/${artistId}/top-tracks?market=US`);
            if (data.tracks && data.tracks.length > 0) {
                const uris = data.tracks.map(t => t.uri);
                await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${deviceId}`, {
                    method: 'PUT', headers: { Authorization: `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ uris: uris })
                });
            }
        }

        function togglePlay() { if (player) player.togglePlay(); }
        function skipNext() { if (player) player.nextTrack(); }
        function skipPrev() { if (player) player.previousTrack(); }

        // ==========================================
        // LYRICS ENGINE (LRCLIB API)
        // ==========================================
        async function fetchRealLyrics(artist, title) {
            const container = document.getElementById('lyrics-container');
            container.innerHTML = '<p class="text-white/40 text-2xl font-bold mt-20 animate-pulse">Searching for lyrics...</p>';
            parsedLyrics = [];
            currentLyricIndex = -1;

            try {
                const cleanTitle = title.replace(/\(feat\..*?\)|\- .*?Remaster.*/gi, '').trim();
                const res = await fetch(`https://lrclib.net/api/get?artist_name=${encodeURIComponent(artist)}&track_name=${encodeURIComponent(cleanTitle)}`);
                if (!res.ok) throw new Error('Lyrics not found');

                const data = await res.json();
                if (data.syncedLyrics) parseLRC(data.syncedLyrics);
                else if (data.plainLyrics) renderPlainLyrics(data.plainLyrics);
                else throw new Error('No lyrics format found');
            } catch (err) {
                container.innerHTML = '<p class="text-white/40 text-2xl font-bold mt-20">Lyrics not available for this track.</p>';
            }
        }

        function parseLRC(lrcText) {
            parsedLyrics = [];
            const lines = lrcText.split('\n');
            const timeRegex = /\[(\d{2}):(\d{2})\.(\d{2,3})\]/;

            let html = '';
            let lineIdx = 0;

            lines.forEach(line => {
                const match = timeRegex.exec(line);
                if (match) {
                    const min = parseInt(match[1], 10);
                    const sec = parseInt(match[2], 10);
                    const ms = match[3].length === 2 ? parseInt(match[3], 10) * 10 : parseInt(match[3], 10);
                    const timeInSeconds = min * 60 + sec + ms / 1000;
                    const text = line.replace(timeRegex, '').trim();

                    if (text) {
                        parsedLyrics.push({ time: timeInSeconds, text: text });
                        html += `<p id="lyric-${lineIdx}" onclick="seekToLyric(${timeInSeconds})" class="lyric-line text-3xl sm:text-4xl lg:text-5xl font-extrabold tracking-tight mb-10 cursor-pointer hover:opacity-60 leading-tight">${text}</p>`;
                        lineIdx++;
                    }
                }
            });

            if (parsedLyrics.length > 0) {
                document.getElementById('lyrics-container').innerHTML = html;
                updateLyricsSync();
            }
        }

        function renderPlainLyrics(plainText) {
            const lines = plainText.split('\n');
            let html = '';
            lines.forEach(line => {
                if (line.trim()) html += `<p class="text-3xl sm:text-4xl lg:text-5xl font-extrabold tracking-tight mb-10 text-white leading-tight">${line.trim()}</p>`;
            });
            document.getElementById('lyrics-container').innerHTML = html;
        }

        async function seekToLyric(timeInSeconds) {
            if (!deviceId || !token) return;
            await fetch(`https://api.spotify.com/v1/me/player/seek?position_ms=${Math.floor(timeInSeconds * 1000)}&device_id=${deviceId}`, {
                method: 'PUT', headers: { Authorization: `Bearer ${token}` }
            });
            currentTime = timeInSeconds * 1000;
            updateLyricsSync();
        }

        function updateLyricsSync() {
            if (!parsedLyrics.length) return;
            const currentSec = (currentTime / 1000) + 0.4;

            let targetIndex = -1;
            for (let i = 0; i < parsedLyrics.length; i++) {
                if (currentSec >= parsedLyrics[i].time) targetIndex = i;
                else break;
            }

            if (targetIndex !== -1 && targetIndex !== currentLyricIndex) {
                if (currentLyricIndex >= 0 && document.getElementById(`lyric-${currentLyricIndex}`)) {
                    document.getElementById(`lyric-${currentLyricIndex}`).classList.remove('lyric-active');
                }
                currentLyricIndex = targetIndex;
                const activeEl = document.getElementById(`lyric-${currentLyricIndex}`);
                if (activeEl) {
                    activeEl.classList.add('lyric-active');
                    activeEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        }

        // ==========================================
        // HIGH-FIDELITY TIMER ENGINE
        // ==========================================
        function startProgressTimer() {
            clearInterval(progressInterval);
            lastTickTime = performance.now();

            if (isPlaying) {
                progressInterval = setInterval(() => {
                    const now = performance.now();
                    const delta = now - lastTickTime;
                    lastTickTime = now;

                    currentTime += delta;
                    if (currentTime > duration) currentTime = duration;

                    const progressPercent = (currentTime / duration) * 100;
                    document.getElementById('mini-progress').style.width = `${progressPercent}%`;
                    document.getElementById('fs-progress').style.width = `${progressPercent}%`;
                    document.getElementById('fs-current-time').innerText = formatTime(currentTime);

                    if (activeFsView === 'lyrics') updateLyricsSync();
                }, 100);
            }
        }

        // ==========================================
        // UI UPDATES
        // ==========================================
        function updatePlayerUI() {
            if (!currentTrack) return;

            const art = currentTrack.album.images[0]?.url || '';
            const title = currentTrack.name;
            const artist = currentTrack.artists[0].name;

            document.getElementById('bottom-player').classList.remove('bottom-player-hidden');

            if (currentTrackId !== currentTrack.id) {
                currentTrackId = currentTrack.id;
                fetchRealLyrics(artist, title);
                if (activeFsView === 'insights') checkAndGenerateInsight();
            }

            document.getElementById('mini-title').innerText = title;
            document.getElementById('mini-artist').innerText = artist;
            document.getElementById('fs-title').innerText = title;
            document.getElementById('fs-artist').innerText = artist;

            document.getElementById('mini-art').src = art;
            document.getElementById('fs-art').src = art;

            const fsMeshes = ['fs-mesh-1', 'fs-mesh-2'];
            fsMeshes.forEach(id => document.getElementById(id).style.backgroundImage = `url(${art})`);

            updatePlayIcon('mini-play-icon', isPlaying);
            updatePlayIcon('fs-play-icon', isPlaying);
            document.getElementById('fs-total-time').innerText = formatTime(duration);
        }

        function updatePlayIcon(id, playing) {
            const icon = document.getElementById(id);
            if (playing) {
                icon.setAttribute('data-lucide', 'pause');
                icon.classList.remove('ml-1', 'ml-1.5');
            } else {
                icon.setAttribute('data-lucide', 'play');
                if (id === 'fs-play-icon') icon.classList.add('ml-1.5');
                else icon.classList.add('ml-1');
            }
            lucide.createIcons();
        }

        // ==========================================
        // FLEXBOX FULLSCREEN TOGGLES
        // ==========================================
        function toggleFullScreen(show) {
            const fsEl = document.getElementById('fullscreen-player');
            if (show) {
                fsEl.classList.remove('full-screen-hidden');
                switchFsView('artwork');
            } else {
                fsEl.classList.add('full-screen-hidden');
            }
        }

        function switchFsView(view) {
            activeFsView = view;

            ['artwork', 'lyrics', 'insights'].forEach(v => {
                const btn = document.getElementById(`btn-${v}`);
                btn.className = "text-white/60 hover:text-white px-8 py-2 rounded-full text-[13px] font-extrabold transition-all flex items-center gap-2 tracking-wide";
            });
            document.getElementById('sparkles-icon').classList.remove('text-black');

            const activeBtn = document.getElementById(`btn-${view}`);
            activeBtn.className = view === 'insights'
                ? "bg-white text-black shadow-lg px-8 py-2 rounded-full text-[13px] font-extrabold transition-all flex items-center gap-2 tracking-wide"
                : "bg-white/20 shadow-lg text-white px-8 py-2 rounded-full text-[13px] font-extrabold transition-all flex items-center gap-2 tracking-wide";

            if (view === 'insights') document.getElementById('sparkles-icon').classList.add('text-black');

            const artContainer = document.getElementById('fs-art-container');
            const sidePanel = document.getElementById('fs-side-panel');
            const panelLyrics = document.getElementById('fs-lyrics-panel');
            const panelInsights = document.getElementById('fs-insights-panel');

            if (view === 'artwork') {
                artContainer.className = "flex flex-col transition-all duration-[800ms] ease-[cubic-bezier(0.25,1,0.5,1)] items-center justify-center w-full";
                document.getElementById('fs-meta').classList.remove('opacity-0', 'hidden');

                sidePanel.className = "w-0 opacity-0 overflow-hidden transition-all duration-[800ms] ease-[cubic-bezier(0.25,1,0.5,1)] flex flex-col justify-center h-[85vh] shrink-0";

                setTimeout(() => {
                    panelLyrics.classList.add('hidden');
                    panelInsights.classList.add('hidden');
                }, 800);
            } else {
                artContainer.className = "flex flex-col transition-all duration-[800ms] ease-[cubic-bezier(0.25,1,0.5,1)] items-center justify-center w-[40%]";
                document.getElementById('fs-meta').classList.add('opacity-0', 'hidden');

                sidePanel.className = "w-[60%] opacity-100 overflow-visible transition-all duration-[800ms] ease-[cubic-bezier(0.25,1,0.5,1)] flex flex-col justify-center h-[85vh] shrink-0";

                if (view === 'lyrics') {
                    panelLyrics.classList.remove('hidden');
                    panelInsights.classList.add('hidden');
                    updateLyricsSync();
                } else if (view === 'insights') {
                    panelInsights.classList.remove('hidden');
                    panelLyrics.classList.add('hidden');
                    checkAndGenerateInsight();
                }
            }
        }

        // ==========================================
        // GEMINI AI INTEGRATION
        // ==========================================
        async function checkAndGenerateInsight() {
            const apiKey = localStorage.getItem('gemini_api_key');
            const insightText = document.getElementById('ai-insight-text');
            const keySetup = document.getElementById('gemini-key-setup');

            if (!apiKey) {
                insightText.classList.add('hidden');
                keySetup.classList.remove('hidden');
                return;
            }

            insightText.classList.remove('hidden');
            keySetup.classList.add('hidden');

            if (!currentTrack) return;
            insightText.innerText = "Analyzing audio composition framework...";

            try {
                const prompt = `Write an ultra-premium, 2-sentence stylistic analysis about the song "${currentTrack.name}" by ${currentTrack.artists[0].name}. Make it sound like an Apple Music editorial review. Do not use quotes.`;
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                if (data.error) throw new Error(data.error.message);

                insightText.innerHTML = `${data.candidates[0].content.parts[0].text}
          <br><button onclick="clearGeminiKey()" class="mt-8 text-sm text-white font-bold uppercase tracking-widest opacity-70 hover:opacity-100 transition-opacity">Reset API Key</button>`;
            } catch (err) {
                insightText.innerHTML = `Editorial insights unavailable. Invalid API Key.
          <br><button onclick="clearGeminiKey()" class="mt-8 text-sm text-white font-bold uppercase tracking-widest opacity-70 hover:opacity-100 transition-opacity">Change API Key</button>`;
            }
        }

        function saveGeminiKey() {
            const key = document.getElementById('gemini-key-input').value.trim();
            if (key) {
                localStorage.setItem('gemini_api_key', key);
                checkAndGenerateInsight();
            }
        }

        function clearGeminiKey() {
            localStorage.removeItem('gemini_api_key');
            checkAndGenerateInsight();
        }

        function formatTime(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const m = Math.floor(totalSeconds / 60);
            const s = Math.floor(totalSeconds % 60);
            return `${m}:${s < 10 ? '0' : ''}${s}`;
        }
    </script>
</body>

</html>